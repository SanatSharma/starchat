<!DOCTYPE html><html class=''>
		<html lang="en">
		<head> 
			<meta charset="UTF-8">
			<title>Center</title>
			<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
			<script src="https://use.fontawesome.com/1c6f725ec5.js"></script>
			<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
			<link rel="stylesheet" href="chat.css">
			<script>
			var messagesPanel, typedMessage, first = true, ws;
			const TESTINGURI = "ws://localhost:4000";
			const PRODURI = "ws://ec2-18-218-225-8.us-east-2.compute.amazonaws.com:4000";
			var statusBar;
			const GENERAL = "general";
			const PRIVATE = "private";
			var currentId = GENERAL;
			const SESSION = "00001";
			var messages = {};
			function main() {
				messagesPanel = document.getElementById("messagePanel");
				typedMessage = document.getElementById("typedMessage");
				statusBar = document.getElementById("statusBar");
				var list = document.getElementById("contacts");



				var contact = document.createElement("div");
						contact.className = "new-message-contact active-contact";
						var text = document.createElement("div");
						contact.id = GENERAL;  // general chat 
						contact.onclick = displayMessages;
						text.className = "contact-text";
						text.textContent = "Studio - General";
						var newMessage = document.createElement("div");
						//newMessage.className ="new-message";
						//newMessage.textContent = "99";
						//newMessage.id = "nm";
						//contact.appendChild(newMessage);
						contact.appendChild(text);
						list.appendChild(contact);				



				var contact2 = document.createElement("div");
						contact2.className = "new-message-contact";
						var text2 = document.createElement("div");
						contact2.onclick = displayMessages;
						contact2.id = PRIVATE; // private chat
						text2.className = "contact-text";
						text2.textContent = "Studio - Private";
						contact2.appendChild(text2);
						list.appendChild(contact2);

				messages[GENERAL] = [];
				messages[PRIVATE] = [];
				
				ws = new WebSocket(TESTINGURI);

				ws.onerror = function(e){
					alert("Could not connect to server");
				}

				ws.onopen = function(e) {
					ws.send(JSON.stringify({
						session: SESSION,
						type: "centerAdd",
						name: "puneetCenter"
					}));
					statusBar.textContent = "Connected!";
				}

				ws.onmessage = function ws_message(input){
					var data = input.data;
					if (isJson(data)){
						console.log("Received message!" + data);
						var obj = JSON.parse(data);
						var messageWrapper = {'type': 'you', 'data': obj.data};
						if (obj.type == "singleMessage"){
							if(currentId == PRIVATE)
								addMessage(obj.data, true);
							messages[PRIVATE].push(messageWrapper);
						}
						else{
							if(currentId == GENERAL)
								addMessage(obj.data, true);

							messages[GENERAL].push(messageWrapper);
						}

					}
					else{
						console.log("Data received is not JSON");
					}
				};

				ws.onclose = function() {
					statusBar.textContent = 'Connection lost';
					typedMessage.disabled = true;
				};
				typedMessage.onkeydown = function(e) {
					if (e.keyCode === 13 && !e.shiftKey) {
						if (typedMessage.value.length) {
							typedMessage.value = typedMessage.value.substring(0, 512);
							addMessage(typedMessage.value, false);
							var messageWrapper = {'type': 'me', 'data': typedMessage.value};
							if(currentId == GENERAL){
								ws.send(JSON.stringify({
									type: "groupMessage",
									group: "center",
									session: SESSION,
									data: typedMessage.value
								}));
								messages[GENERAL].push(messageWrapper);
							}
							else{
								ws.send(JSON.stringify({
									type: "singleMessage",
									group: "center",
									session: SESSION,
									data: typedMessage.value
								}));
								messages[GENERAL].push(messageWrapper);
							}


						}
						typedMessage.value = "";
						return false;
					}
					return true;
				};

				typedMessage.onclick = function() {
					console.log("Clicked typed message");
					if (first) {
						typedMessage.value = "";
						first = false;
					}
				}

				if (localStorage.id) {
					id = localStorage.id;
				} else {
					id = Math.floor(Math.random() * 1000000);
					localStorage.id = id;
				}


			}


			function isJson(str) {
			try {
				JSON.parse(str);
			} catch (e) {
				console.log(e);
				return false;
			}
			return true;
			}

			function displayMessages(evt){
					var name = evt.target;
					console.log("reaching here");
					var id = this.id // get the contact id
					var c = currentId;
					// display on{ly the private chat messages for that id
					if (c != id){
						document.getElementById(id).className ="new-message-contact active-contact";
						document.getElementById(currentId).className = "new-message-contact"; 
						currentId = id;
						console.log("Current id: " + currentId);
						messagesPanel.innerHTML = "";
						var messageList = messages[id];                    
					}
				
					// display appropriate messages
					messageList.forEach(function(mess){
							if(mess.type == "you"){
								addMessage(mess.data, true);
							}
							else
								addMessage(mess.data, false);
						});
				}


			function addMessage(message, left) {
				var flexBox = document.createElement('div');if (!left)
				flexBox.className = "chat-bubble me";
			  else
				flexBox.className = "chat-bubble you";
			//  flexBox.style = 'display: flex; ' + (left ? '' : 'justify-content: flex-end');
				var time = new Date().toLocaleTimeString();
				var messageBox = document.createElement('p');
				messageBox.className = "content";
				var timeShow = document.createElement('p');
				timeShow.className = "time";
				timeShow.textContent = time; 
				messageBox.textContent = message;
				flexBox.appendChild(messageBox);
				flexBox.appendChild(timeShow);
			//	if (messages.length == 50) {
			//		messagesPanel.removeChild(messages.shift());
			//	}
			//	messages.push(flexBox);
				setTimeout(function() {
					messageBox.className = "show";
				}, 10);

				var wereBottomScrolled = true;//messagesPanel.scrollTop == messagesPanel.scrollHeight;
				messagesPanel.appendChild(flexBox);
				if (wereBottomScrolled) {
					messagesPanel.scrollTop = messagesPanel.scrollHeight;
				}
			}
			</script>
				
		</head>
		  <body onload="main();">
	
			<div class="green-background"></div>
			<div class="wrap">
				<section class="left">
					<div class="profile">
						
					</div>
					<div class="wrap-search">
						<div class="search">
							<i class="fa fa-search fa" aria-hidden="true"></i>
							<input type="text" class="input-search" placeholder="Search">
						</div>
					</div>
					<div class="contact-list" id="contacts"></div>
				</section>
		
				<section class="right">
					<div class="chat-head">
						<div class="chat-name" style="padding-left:20px">
							<h1 class="font-name">Center</h1>
							<p id="statusBar" class="font-online">Connecting</p>
						</div>
						<i class="fa fa-times fa-lg" aria-hidden="true" id="close-contact-information"></i>
					</div>
					<div class="wrap-chat">
						<div class="chat" id="messagePanel"></div>
						<div class="information" ></div>
					</div>
					<div class="wrap-message">
						<i class="fa fa-smile-o fa-lg" aria-hidden="true"></i>
						<div class="message">
							<input type="text" id="typedMessage" class="input-message" placeholder="Type Message">
						</div>
					</div>
				</section>
			</div>		
		</body>
		</html>
	