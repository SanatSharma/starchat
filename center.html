<!DOCTYPE html><html class=''>
		<html lang="en">
		<head> 
			<meta charset="UTF-8">
			<title>Center</title>
			<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
			<script src="https://use.fontawesome.com/1c6f725ec5.js"></script>
			<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
			<link rel="stylesheet" href="chat.css">
			<script>
			var messagesPanel, typedMessage, first = true, ws, id;
			var messages = [];
			function main() {
				messagesPanel = document.getElementById("messagePanel");
				typedMessage = document.getElementById("typedMessage");
				var list = document.getElementById("contacts");


				var contact = document.createElement("div");
						contact.className = "new-message-contact active-contact";
						var text = document.createElement("div");
						contact.id = "teacher";
						text.className = "contact-text";
						text.textContent = "Studio";
						contact.appendChild(text);
						list.appendChild(contact);

				typedMessage.onkeydown = function(e) {
					if (e.keyCode === 13 && !e.shiftKey) {
						if (typedMessage.value.length) {
							typedMessage.value = typedMessage.value.substring(0, 512);
							addMessage(id, typedMessage.value, false);
							ws.send(JSON.stringify({
								type: "singleMessage",
								group: "center",
								session: "00001",
								data: typedMessage.value
							}));
						}
						typedMessage.value = "";
						return false;
					}
					return true;
				};

				typedMessage.onclick = function() {
					console.log("Clicked typed message");
					if (first) {
						typedMessage.value = "";
						first = false;
					}
				}

				if (localStorage.id) {
					id = localStorage.id;
				} else {
					id = Math.floor(Math.random() * 1000000);
					localStorage.id = id;
				}

				ws = new WebSocket("ws://localhost:4000");

				ws.onerror = function(e){
					alert("Could not connect to server");
				}

				ws.onopen = function(e) {
					ws.send(JSON.stringify({
						session: "00001",
						type: "centerAdd",
						name: "puneetCenter"
					}));
					statusBar.textContent = "Connected!";
				}

				ws.onmessage = function ws_message(input){
					var data = input.data;
					if (isJson(data)){
						console.log("Received message!" + data);
						var obj = JSON.parse(data);
						addMessage(id, obj.data, true);
					}
					else{
						console.log("Data received is not JSON");
					}
				};

				ws.onclose = function() {
					statusBar.textContent = 'Connection lost';
					typedMessage.disabled = true;
				};
			}

			function isJson(str) {
			try {
				JSON.parse(str);
			} catch (e) {
				console.log(e);
				return false;
			}
			return true;
			}

			function addMessage(id, message, left) {
				var flexBox = document.createElement('div');if (!left)
				flexBox.className = "chat-bubble me";
			  else
				flexBox.className = "chat-bubble you";
			//  flexBox.style = 'display: flex; ' + (left ? '' : 'justify-content: flex-end');
				var time = new Date().toLocaleTimeString();
				var messageBox = document.createElement('p');
				messageBox.className = "content";
				var timeShow = document.createElement('p');
				timeShow.className = "time";
				timeShow.textContent = time; 
				messageBox.textContent = message;
				flexBox.appendChild(messageBox);
				flexBox.appendChild(timeShow);
				if (messages.length == 50) {
					messagesPanel.removeChild(messages.shift());
				}
				messages.push(flexBox);
				setTimeout(function() {
					messageBox.className = "show";
				}, 10);

				var wereBottomScrolled = true;//messagesPanel.scrollTop == messagesPanel.scrollHeight;
				messagesPanel.appendChild(flexBox);
				if (wereBottomScrolled) {
					messagesPanel.scrollTop = messagesPanel.scrollHeight;
				}
			}
			</script>
				
		</head>
		  <body onload="main();">
	
			<div class="green-background"></div>
			<div class="wrap">
				<section class="left">
					<div class="profile">
						
					</div>
					<div class="wrap-search">
						<div class="search">
							<i class="fa fa-search fa" aria-hidden="true"></i>
							<input type="text" class="input-search" placeholder="Search">
						</div>
					</div>
					<div class="contact-list" id="contacts"></div>
				</section>
		
				<section class="right">
					<div class="chat-head">
						<div class="chat-name" style="padding-left:20px">
							<h1 class="font-name">Center</h1>
							<p id="statusBar" class="font-online">Connecting</p>
						</div>
						<i class="fa fa-times fa-lg" aria-hidden="true" id="close-contact-information"></i>
					</div>
					<div class="wrap-chat">
						<div class="chat" id="messagePanel"></div>
						<div class="information" ></div>
					</div>
					<div class="wrap-message">
						<i class="fa fa-smile-o fa-lg" aria-hidden="true"></i>
						<div class="message">
							<input type="text" id="typedMessage" class="input-message" placeholder="Type Message">
						</div>
					</div>
				</section>
			</div>		
		</body>
		</html>
	